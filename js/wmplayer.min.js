var WMPlayer=function(){function t(t,e){function r(e){o.settings={playMode:3,playList:0,playSong:0,autoPlay:!1,lrcTopPos:0,defaultVolume:100},o.util={rand:function(t,e){void 0===e&&(e=t,t=0);var r=0;do r=Math.round(Math.random()*e);while(t>r);return r},fillByZero:function(t,e){t=String(t);for(var r=t.length;e>r;r++)t="0"+t;return t},regexp:{lrc:new RegExp("\\[(\\d{2})(&#58;|:)(\\d{2})(&#46;|\\.)(\\d{2})\\]([^\\[]+)","g")}},o.callbacks={afterInit:null,beforePlay:null,timeUpdate:null,end:null,mute:null,changeMode:null},o.data=$("<div></div>"),$.extend(!0,o.settings,t);var r=$(o.settings.containerSelector);o.audio=$("<audio></audio>").attr({preload:"preload"}),o._data({currentLrc:0,currentSong:0,currentList:0,displayList:0,playMode:0}),o.dom={container:r,cover:r.find(".wm-cover"),name:r.find(".wm-name"),singer:r.find(".wm-singer"),currentTime:r.find(".wm-time-current"),allTime:r.find(".wm-time-all"),prev:r.find(".wm-prev"),play:r.find(".wm-pause"),next:r.find(".wm-next"),vol:r.find(".wm-vol-img"),volRange:r.find(".wm-vol-range"),progress:r.find(".wm-pro-current"),progressAll:r.find(".wm-pro"),lrc:r.find(".wm-lrc"),listTitle:r.find(".wm-list-title"),list:r.find(".wm-list")},o.settings.lineHeight=parseInt(o.dom.lrc.css("line-height")),o.settings.listEleName=$.parseHTML(o.settings.listFormat)[0].nodeName.toLowerCase(),e&&e.apply(o)}function n(){o.dom.cover.error(function(){$(this).attr("src",o.settings.defaultImg)}),o.dom.prev.click(function(){o.prev()}),o.dom.next.click(function(){o.next()}),o.dom.play.click(function(){o.audio.prop("paused")?o.play():o.pause()}),o.dom.volRange.on(o.settings.volSlideEventName,function(t,e){o.audio.prop("volume",e/100)}),o.dom.vol.click(function(){o.toggleMute()}),o.dom.listTitle.on("click","li",function(){var t=$(this).index();o.changeList(t)}),o.audio.on("canplay",function(){s(o.getDuration(),o.dom.allTime)}).on("timeupdate",function(){var t=o.getCurrentTime();s(t,o.dom.currentTime),o.dom.progress.css("width",100*o.getPercent()+"%");var e=parseInt(o._data("currentLrc")),r=o.getLrc(t,!1);e!=r&&(o._data("currentLrc",r),o.dom.lrc.find(".wm-lrc-current").removeClass("wm-lrc-current"),o.dom.lrc.each(function(t,e){e=$(e);var n=e.find(".wm-lrc-time-"+r).addClass("wm-lrc-current").position(),i=n?n.top:0,a=e.scrollTop(),s=parseInt(e.attr("wm-top")||0),o=parseInt(e.attr("wm-time")||0);e.animate({scrollTop:a+i-s},o)})),o._trigger("timeUpdate")}).on("ended",function(){var t=o._trigger("end");t!==!1&&a()});var t=$.parseHTML(o.settings.listFormat)[0].nodeName.toLowerCase();o.dom.list.on("click",t,function(){o.play(parseInt(o._data("displayList")),$(this).index())}),o.dom.progressAll.click(function(t){var e=$(this).width(),r=Math.min(Math.max(t.offsetX,0),e),n=r/e;o.setCurrentTime(o.getDuration()*n)}),o.dom.list.on("click",o.settings.listEleName,function(){o.play(parseInt(o._data("displayList")),$(this).index())}),o.dom.container.on("mousedown",".wm-disabled",function(){return!1})}function i(){o.list=[];for(var t=o.settings.songList,e=0;e<t.length;e++){o.list[e]=[];for(var r=0;r<t[e].length;r++)if(t[e][r].basic){o.list[e].listName=t[e][r].name||"-",o.list[e].singerName=t[e][r].singer||"-",o.list[e].imgSrc=t[e][r].img||o.settings.defaultImg,t[e].splice(r,1);break}o.addSong(t[e],e)}}function a(){var t=parseInt(o._data("playMode")),e=o.getSongNum();switch(t){case 0:var r=o._data("currentSong");r!=e-1?o.next():o.pause();break;case 1:o.play();break;case 2:case 3:default:o.next()}}function s(t,e){var r=o.util.fillByZero(Math.floor(t/60),2),n=o.util.fillByZero(Math.floor(t%60),2);e.html(r+":"+n)}var o=this;r(e),n(),i(),o.changePlayMode(o.settings.playMode);var l="";$.each(o.list,function(t){l+='<li class="wm-list-title-'+t+'">'+o.list[t].listName+"</li>"}),o.dom.listTitle.html(l),o.changeList(o.settings.playList),o._trigger("afterInit"),o.settings.autoPlay?o.play(o.settings.playList,o.settings.playSong):o._setInfo(o.settings.playList,o.settings.playSong)}return $.extend(t.prototype,{_setLrc:function(t,e){var r=this;return r.dom.lrc.html("").scrollTop(0),e===!0?(r._data({ajaxList:r.getCurrentList(),ajaxSong:r.getCurrentSong()}),$.get(t,function(t,e){if("success"==e){t=r._parseLrc(t);var n=parseInt(r._data("ajaxList")),i=parseInt(r._data("ajaxSong"));r.list[n][i].ajax=!1,r.list[n][i].lrc=t;var a=r.getCurrentList(),s=r.getCurrentSong();i==s&&n==a&&r._setLrc(t)}},"text"),0):void $.each(t,function(t,e){r.dom.lrc.append($("<li></li>").addClass("wm-lrc-time-"+t).html(e))})},_setInfo:function(t,e){var r=this,n=r.getInfo(t,e);r.audio.attr("src",n.src),r._data({currentList:t,currentSong:e}),r.dom.name.html(n.name),r.dom.singer.html(n.singer),r.dom.cover.attr("src",n.img),r._setLrc(n.lrc,n.ajax),r.dom.progress.width(0),t==r.getDisplayList()&&r._setCurrent(e)},_setCurrent:function(t){var e=this,r=e.dom.list;r.find(".wm-list-current").removeClass("wm-list-current"),r.children().eq(t).addClass("wm-list-current")},_parseLrc:function(t){var e=this,r=e.util.regexp.lrc,n={};for(t=t.replace(/(\\n|\\r)/g,"<br>");;){var i=r.exec(t);if(!i)break;var a=Math.round(1e3*(60*parseInt(i[1])+parseInt(i[3])+parseInt(i[5])/100));n[a]=$.trim(i[6])||" "}return n},_trigger:function(t){var e=this;return e.callbacks[t]&&e.callbacks[t].apply(e)},_data:function(t,e){return void 0===e?parseInt(this.data.data(t)):void this.data.data(t,e)},next:function(){var t=this,e=t.getPlayMode(),r=t.getSongNum();switch(e){case 2:var n=t.util.rand(0,r-1);t.play(n);break;case 0:case 3:case 1:default:var i=t.getCurrentSong()+1;i>=r&&(i=0),t.play(i)}},prev:function(){var t=this,e=t.getCurrentSong()-1,r=t.getCurrentList(!0);0>e&&(e=r.num-1),t.play(e)},play:function(t,e){var r=this;if(void 0===t&&void 0===e){var n=r._trigger("beforePlay");if(n===!1)return!1;r.audio.get(0).play(),r.dom.play.addClass("wm-play")}else if(void 0!==t&&void 0===e)e=t,t=r.getCurrentList(),r.play(t,e);else{var i=r.getSongNum(t);e>=i?e=i-1:0>e&&(e=0),r._setInfo(t,e),r.play()}},pause:function(){var t=this;t.dom.play.removeClass("wm-play"),t.audio.get(0).pause()},getDuration:function(){return this.audio.prop("duration")},getCurrentTime:function(){return this.audio.prop("currentTime")},getPercent:function(){return this.getCurrentTime()/this.getDuration()},setCurrentTime:function(t){var e=this;t=Math.min(t,e.getDuration()),t=Math.max(0,t);var r=e.audio.get(0).buffered,n=r.start(0),i=r.end(0);t=Math.max(n,Math.min(i,t)),e.audio.prop("currentTime",t)},addSong:function(t,e){var r=this;if(e=void 0!==e?e:r.getCurrentList(),t instanceof Array)for(var n=0;n<t.length;n++)r.addSong(t[n],e);else{var i=t.lrc;t.ajax!==!0&&(i=r._parseLrc(i));var a={lrc:i,name:t.name||"-",singer:t.singer||r.list[e].singerName,src:t.src||"-",img:t.img||r.list[e].imgSrc},s=$.extend({},t,a);r.list[e].push(s),e==r.getCurrentList()&&r.changeList(e)}},getSongNum:function(t){var e=this;return t=void 0!==t?t:e.getCurrentList(),e.list[t].length},getCurrentSong:function(t){var e=this;return t=void 0!==t?t:!1,t?e.getInfo():parseInt(e._data("currentSong"))},getCurrentList:function(t){var e=this;return t=void 0!==t?t:!1,t?e.getList(e.getCurrentList()):parseInt(e._data("currentList"))},getDisplayList:function(t){var e=this;return t=void 0!==t?t:!1,t?e.getList(e.getDisplayList()):parseInt(e._data("displayList"))},getList:function(t){var e=this,r=e.list[t];return{name:r.listName,num:r.length,songs:r}},getInfo:function(t,e){var r=this;return t=void 0!==t?t:r.getCurrentList(),e=void 0!==e?e:r.getCurrentSong(),r.list[t][e]},getLrc:function(t,e){var r=this;e=void 0!==e?e:!0,t=void 0!==t?1e3*t:1e3*r.getCurrentTime();var n,i=r.getCurrentSong(!0).lrc,a=0;return $.each(i,function(e){return e>t?!1:void(a=e)}),n=a,e?r.getCurrentSong(!0).lrc[n]:n},changeList:function(t){var e=this;e.dom.listTitle.find(".wm-list-title-current").removeClass("wm-list-title-current"),e.dom.listTitle.find(".wm-list-title-"+t).addClass("wm-list-title-current"),e._data("displayList",t),e.dom.list.html("");for(var r=e.settings.listFormat,n=/\$\{(\w+)}\$/g,i=0;i<e.list[t].length;i++){for(var a=r;;){var s=n.exec(r);if(!s)break;a=a.replace(s[0],e.list[t][i][s[1]]||"-")}e.dom.list.append(a)}t==e.getCurrentList()&&e._setCurrent(e.getCurrentSong())},changePlayMode:function(t){var e=this;t=Math.max(Math.min(parseInt(t),3),0),e._data("playMode",t),e._trigger("changeMode")},getPlayMode:function(){return parseInt(this._data("playMode"))},getIsMuted:function(){return this.audio.prop("muted")},mute:function(){var t=this;t.dom.vol.addClass("wm-mute"),t.audio.prop("muted",!0),t._trigger("mute")},cancelMute:function(){var t=this;t.audio.prop("muted",!1),t.dom.vol.removeClass("wm-mute"),t._trigger("mute")},toggleMute:function(){var t=this;t.getIsMuted()?t.cancelMute():t.mute()},on:function(t,e){var r=this;return r.callbacks[t]=e,r},unBindEvent:function(t){var e=this;return e.callbacks[t]=null,e}}),t}();